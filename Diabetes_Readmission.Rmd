---
title: "Diabetic_Readmission"
author: "Tiffany Chua"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Working Directory}
getwd()
```

```{r Libraries}
library(Amelia)
library(ggplot2)
library("GGally")
library(caTools)
library(caret)
library(class)
library("e1071")
library(psych)
library(corrplot)
library("ISLR")
library("cluster")
library(datasets)
library("factoextra")
library(dplyr)
library(rpart)
library(pROC)
library("rpart.plot")
library("randomForest")
library(pastecs)
library(tidyr)
library(Hmisc)
library(tidyverse)
library(car)
library(varImp)
library(stats)
library(data.table)
library(DT)
```

# Diabetes Readmission Project
Dataset Information:
The dataset represents 10 years (1999-2008) of clinical care at 130 US hospitals and integrated delivery networks. It includes over 50 features representing patient and hospital outcomes. Information was extracted from the database for encounters that satisfied the following criteria.

* (1) It is an inpatient encounter (a hospital admission).
* (2) It is a diabetic encounter, that is, one during which any kind of diabetes was entered to the system as a diagnosis.
* (3) The length of stay was at least 1 day and at most 14 days.
* (4) Laboratory tests were performed during the encounter.
* (5) Medications were administered during the encounter.

The data contains such attributes as patient number, race, gender, age, admission type, time in hospital, medical specialty of admitting physician, number of lab test performed, HbA1c test result, diagnosis, number of medication, diabetic medications, number of outpatient, inpatient, and emergency visits in the year before the hospitalization, etc.

As the dataset has unusual characters (?) in place of NAs, I will change the string to NA upon loading the dataset.
```{r Load Dataset}
dataset <- read.csv("./diabetic_data.csv",
                    na.string = "?",
                    header = T)
head(dataset)
```

## ID Mapping

Categorical/factor variables:

* admission_type_id
  * 1. Emergency
  * 2. Urgent
  * 3. Elective
  * 4. Newborn
  * 5. Not available  --> NA
  * 6. NULL           --> NA
  * 7. Trauma Center
  * 8. Not Mapped     --> NA
  
* discharge_disposition_id
  * 1. Discharged to home
  * 2. Discharged/transferred to another short term hospital
  * 3. Discharged/transferred to SNF
  * 4. Discharged/transferred to ICF
  * 5. Discharged/transferred to another type of inpatient care institution
  * 6. Discharged/transferred to home with home health service
  * 7. Left AMA 
  * 8. Discharged/transferred to home under care of Home IV provider
  * 9. Admitted as an inpatient to this hospital
  * 10. Neonate discharged to another hospital for neonatal aftercare
  * 11. Expired
  * 12. Still patient or expected to return for outpatient services
  * 13. Hospice/Home
  * 14. Hospice/Medical facility
  * 15. Discharged/transferred within this institution to Medicare approved swing bed 
  * 16. Discharged/transferred/referred another institution for outpatient services
  * 17. Discharged/transferred/referred to this institution for outpatient services
  * 18. NULL 
  * 19. Expired at home. Medicaid only, hospice
  * 20. Expired in a medical facility. Medicaid only, hospice.
  * 21. Expired, place unknown. Medicaid only, hospice.
  * 22. Discharged/transferred to another rehab fac including rehab units of a hospital .
  * 23. Discharged/transferred to a long term care hospital.
  * 24. Discharged/transferred to a nursing facility certified under Medicaid but not certified under Medicare.
  * 25. Not Mapped
  * 26. Unknown/Invalid
  * 27. Discharged/transferred to a federal health care facility.
  * 28. Discharged/transferred/referred to a psychiatric hospital of psychiatric distinct part unit of a hospital
  * 29. Discharged/transferred to a Critical Access Hospital (CAH).
  * 30. Discharged/transferred to another Type of Health Care Institution not Defined Elsewhere
  
* admission_source_id
  * 1. Physician Referral
  * 2. Clinic Referral
  * 3. HMO Referral
  * 4. Transfer from a hospital
  * 5. Transfer from a Skilled Nursing Facility (SNF)
  * 6. Transfer from another health care facility
  * 7. Emergency Room
  * 8. Court/Law Enforcement
  * 9. Not Available
  * 10. Transfer from critial access hospital
  * 11. Normal Delivery
  * 12. Premature Delivery
  * 13. Sick Baby
  * 14. Extramural Birth
  * 15. Not Available
  * 16. 
  * 17. NULL
  * 18. Transfer From Another Home Health Agency
  * 19. Readmission to Same Home Health Agency
  * 20. Not Mapped
  * 21. Unknown/Invalid
  * 22. Transfer from hospital inpt/same fac reslt in a sep claim
  * 23. Born inside this hospital
  * 24. Born outside this hospital
  * 25. Transfer from Ambulatory Surgery Center
  * 26. Transfer from Hospice

Other column notes:

* Columns to remove:
  * $encounter_id
  * $patient_nbr
  * $payer_code
  * $medical_specialty (maybe?)

## Initial Read

```{r Row & Column Count}
ncol(dataset)
nrow(dataset)
```

```{r Initial Structure}
str(dataset)
```

Because encounter_id and patient_nbr do not provide new information, I will remove these two columns.
```{r Remove Unnecessary Columns 1}
#Because encounter_id and patient_nbr do not provide new information, I will remove these two columns.
dataset1 <- select(dataset,
                   -encounter_id)
dataset1 <- select(dataset1,
                   -patient_nbr)

str(dataset1)
```

### Filtering Dataset

Using max_glu_serum and A1Cresult, I will try to filter the dataset to reduce the number of rows based on the variables with relevant information.
```{r max_glu_serum and A1Cresult}
table(dataset1$max_glu_serum)
table(dataset1$A1Cresult)
```

```{r}
dataset1 <- dataset1[!dataset1$max_glu_serum == "None", ]
dataset1 <- dataset1[!dataset1$A1Cresult == "None", ]

nrow(dataset1)

table(dataset1$max_glu_serum)
table(dataset1$A1Cresult)
```

### NA Variables

#### Unknown/Missing Count

```{r Unknown/Missing Count}
sum(dataset1 == "Unknown/Invalid")
sum(dataset1$gender == "Unknown/Invalid")
```

```{r Convert Unknown to NA}
dataset2 <- dataset1
# Other Unknown/Missing Variables:
# $gender == 3

#Turn strange (Unknown/Invalid) values into NA
dataset2$gender[dataset1$gender == "Unknown/Invalid"] = NA
  
sum(is.na(dataset2))
sapply(dataset2,
       function(x) sum(is.na(x)))
```

```{r Missing Map}
missmap(dataset2)

#NA Count:
# race: 2273
# gender: 3
# weight: 98569
# payer_code: 40256
# medical_specialty: 49949
# diag_1: 21
# diag_2: 358
# diag_3: 1423
```

```{r Post Conversion Read}
str(dataset2)
summary(dataset2)
```

### Cleaning

Due to the large number of NA's in the weight column, I will check to see what percentage of rows are missing in this column.
```{r dataset2$weight}
#Difference in number of rows and NA variables in dataset2$weight
nrow(dataset2) - sum(is.na(dataset2$weight))

#Percentage of missing variables in dataset2$weight
sum(is.na(dataset2$weight)) / nrow(dataset2)
```

```{r Remove Columns}
#Because weight is missing 96.86% of the rows, I will remove this column.
dataset2 <- select(dataset2,
                   -weight)

#payer_code does not provide much useful information, so I will remove this column.
dataset2 <- select(dataset2,
                   -payer_code)

dataset2 <- select(dataset2,
                   -medical_specialty)

str(dataset2)
```

```{r Diagnoses}
myData_d <- dataset2

myData_d$diag_circ <- 0
myData_d$diag_resp <- 0
myData_d$diag_dig <- 0
myData_d$diag_diab <- 0
myData_d$diag_inj <- 0
myData_d$diag_musc <-0
myData_d$diag_geni <- 0
myData_d$diag_neop <-0
myData_d$diag_other <- 0

myData_d$diag_circ[(as.character( myData_d$diag_1) >= "390" & as.character( myData_d$diag_1) <= "459" |  as.character( myData_d$diag_1 ) == "785")
                   | (as.character( myData_d$diag_2) >= "390" & as.character( myData_d$diag_2) <= "459" |  as.character( myData_d$diag_2 ) == "785")
                   | (as.character( myData_d$diag_3) >= "390" & as.character( myData_d$diag_3) <= "459" |  as.character( myData_d$diag_3 ) == "785")] <- 1

#creating diagnosis varible for Diabetes mellitus codes: 250.xx
myData_d$diag_diab[(as.character(myData_d$diag_1) > "249" & as.character(myData_d$diag_1) < "251")
                   | (as.character(myData_d$diag_2) > "249" & as.character(myData_d$diag_2) < "251")
                   | (as.character(myData_d$diag_3) > "249" & as.character(myData_d$diag_3) < "251")] <- 1

#creating diagnosis varible for Respiratory codes: 460-519, 786
myData_d$diag_resp[(as.character( myData_d$diag_1) >= "460" & as.character( myData_d$diag_1) <= "519" |  as.character( myData_d$diag_1 ) == "786")
                   | (as.character( myData_d$diag_2) >= "460" & as.character( myData_d$diag_2) <= "519" |  as.character( myData_d$diag_2 ) == "786")
                   | (as.character( myData_d$diag_3) >= "460" & as.character( myData_d$diag_3) <= "519" |  as.character( myData_d$diag_3 ) == "786")] <- 1

#creating diagnosis varible for Digestive codes: 520-579, 787
myData_d$diag_dig[(as.character( myData_d$diag_1) >= "520" & as.character( myData_d$diag_1) <= "579" |  as.character( myData_d$diag_1 ) == "787")
                  | (as.character( myData_d$diag_2) >= "520" & as.character( myData_d$diag_2) <= "579" |  as.character( myData_d$diag_2 ) == "787")
                  | (as.character( myData_d$diag_3) >= "520" & as.character( myData_d$diag_3) <= "579" |  as.character( myData_d$diag_3 ) == "787")] <- 1

#creating diagnosis varible for Injury codes: 800-999
myData_d$diag_inj[(as.character( myData_d$diag_1) >= "800" & as.character( myData_d$diag_1) <= "999")
                  | (as.character( myData_d$diag_2) >= "800" & as.character( myData_d$diag_2) <= "999")
                  | (as.character( myData_d$diag_3) >= "800" & as.character( myData_d$diag_3) <= "999")] <- 1

#creating diagnosis varible for Musculoskeletal codes: 710-739
myData_d$diag_musc[(as.character( myData_d$diag_1) >= "710" & as.character( myData_d$diag_1) <= "739")
                   | (as.character( myData_d$diag_2) >= "710" & as.character( myData_d$diag_2) <= "739")
                   | (as.character( myData_d$diag_3) >= "710" & as.character( myData_d$diag_3) <= "739")] <- 1

#creating diagnosis varible for Genitourinary codes: 580-629, 788
myData_d$diag_geni[(as.character( myData_d$diag_1) >= "580" & as.character( myData_d$diag_1) <= "629" |  as.character( myData_d$diag_1 ) == "788")
                   | (as.character( myData_d$diag_2) >= "580" & as.character( myData_d$diag_2) <= "629" |  as.character( myData_d$diag_2 ) == "788")
                   | (as.character( myData_d$diag_3) >= "580" & as.character( myData_d$diag_3) <= "629" |  as.character( myData_d$diag_3 ) == "788")] <- 1

#creating diagnosis varible for Neoplasms codes: 140-239
myData_d$diag_neop[(as.character( myData_d$diag_1) >= "140" & as.character( myData_d$diag_1) <= "239")
                   | (as.character( myData_d$diag_2) >= "140" & as.character( myData_d$diag_2) <= "239")
                   | (as.character( myData_d$diag_3) >= "140" & as.character( myData_d$diag_3) <= "239")] <- 1


myData_d$diag_other[(as.character( myData_d$diag_1) == "780") | (as.character( myData_d$diag_1) == "781")
                    | (as.character( myData_d$diag_1) == "784") | (as.character( myData_d$diag_1) >= "790" & as.character( myData_d$diag_1) <= "799")
                    | (as.character( myData_d$diag_1) >= "240" & as.character( myData_d$diag_1) <= "249") | (as.character( myData_d$diag_1) >= "251" & as.character( myData_d$diag_1) <= "279")
                    | (as.character( myData_d$diag_1) >= "680" & as.character( myData_d$diag_1) <= "709") | (as.character( myData_d$diag_1) == "782") 
                    | (as.character( myData_d$diag_1) >= "001" & as.character( myData_d$diag_1) <= "139") | (as.character( myData_d$diag_1) >= "290" & as.character( myData_d$diag_1) <= "319")
                    | (as.character( myData_d$diag_1) >= "280" & as.character( myData_d$diag_1) <= "289") | (as.character( myData_d$diag_1) >= "320" & as.character( myData_d$diag_1) <= "359")
                    | (as.character( myData_d$diag_1) >= "630" & as.character( myData_d$diag_1) <= "679") | (as.character( myData_d$diag_1) >= "360" & as.character( myData_d$diag_1) <= "389")
                    | (as.character( myData_d$diag_1) >= "740" & as.character( myData_d$diag_1) <= "759")
                    | (startsWith(as.character( myData_d$diag_1), 'E'))
                    | (startsWith(as.character( myData_d$diag_1), 'V'))
                    | (as.character( myData_d$diag_2) == "780") | (as.character( myData_d$diag_2) == "781")
                    | (as.character( myData_d$diag_2) == "784") | (as.character( myData_d$diag_2) >= "790" & as.character( myData_d$diag_2) <= "799")
                    | (as.character( myData_d$diag_2) >= "240" & as.character( myData_d$diag_2) <= "249") | (as.character( myData_d$diag_2) >= "251" & as.character( myData_d$diag_2) <= "279")
                    | (as.character( myData_d$diag_2) >= "680" & as.character( myData_d$diag_2) <= "709") | (as.character( myData_d$diag_2) == "782") 
                    | (as.character( myData_d$diag_2) >= "001" & as.character( myData_d$diag_2) <= "139") | (as.character( myData_d$diag_2) >= "290" & as.character( myData_d$diag_2) <= "319")
                    | (as.character( myData_d$diag_2) >= "280" & as.character( myData_d$diag_2) <= "289") | (as.character( myData_d$diag_2) >= "320" & as.character( myData_d$diag_2) <= "359")
                    | (as.character( myData_d$diag_2) >= "630" & as.character( myData_d$diag_2) <= "679") | (as.character( myData_d$diag_2) >= "360" & as.character( myData_d$diag_2) <= "389")
                    | (as.character( myData_d$diag_2) >= "740" & as.character( myData_d$diag_2) <= "759")
                    | (startsWith(as.character( myData_d$diag_2), 'E')) 
                    | (startsWith(as.character( myData_d$diag_2), 'V'))
                    | (as.character( myData_d$diag_3) == "780") | (as.character( myData_d$diag_3) == "781")
                    | (as.character( myData_d$diag_3) == "784") | (as.character( myData_d$diag_3) >= "790" & as.character( myData_d$diag_3) <= "799")
                    | (as.character( myData_d$diag_3) >= "240" & as.character( myData_d$diag_3) <= "249") | (as.character( myData_d$diag_3) >= "251" & as.character( myData_d$diag_3) <= "279")
                    | (as.character( myData_d$diag_3) >= "680" & as.character( myData_d$diag_3) <= "709") | (as.character( myData_d$diag_3) == "782")
                    | (as.character( myData_d$diag_3) >= "001" & as.character( myData_d$diag_3) <= "139") | (as.character( myData_d$diag_3) >= "290" & as.character( myData_d$diag_3) <= "319")
                    | (as.character( myData_d$diag_3) >= "280" & as.character( myData_d$diag_3) <= "289") | (as.character( myData_d$diag_3) >= "320" & as.character( myData_d$diag_3) <= "359")
                    | (as.character( myData_d$diag_3) >= "630" & as.character( myData_d$diag_3) <= "679") | (as.character( myData_d$diag_3) >= "360" & as.character( myData_d$diag_3) <= "389")
                    | (as.character( myData_d$diag_3) >= "740" & as.character( myData_d$diag_3) <= "759")
                    | (startsWith(as.character( myData_d$diag_3), 'E')) 
                    | (startsWith(as.character( myData_d$diag_3), 'V'))] <- 1
dataset2 <- myData_d
```

## Categorical Variables
```{r Class check}
# Max glucose level
# A1C
# Discharge Disposition ID
# Admission Type ID
# Admission Source ID

class(dataset2$discharge_disposition_id)
class(dataset2$admission_type_id)
class(dataset2$admission_source_id)

dataset2$discharge_disposition_id <- as.factor(dataset2$discharge_disposition_id)
dataset2$admission_type_id <- as.factor(dataset2$admission_type_id)
dataset2$admission_source_id <- as.factor(dataset2$admission_source_id)

str(dataset2)
```

### Binary Classification
```{r $readmitted table}
table(dataset2$readmitted)
```

```{r Binary Classsification}
#According to CMS rules, readmission >30 days is considered 'not readmitted', however I will simply classify whether or not the patient was readmitted into the hospital into "YES" and "NO" regardless of number of readmissions. This way, the data will provide more balanced columns for responses.
dataset2$readmitted[dataset2$readmitted == "<30" | dataset2$readmitted == ">30"]= "YES"

table(dataset2$readmitted)
```

```{r}
colnames(dataset2)
```

### Prescriptions

```{r}
table(dataset2$metformin)
table(dataset2$repaglinide)
table(dataset2$nateglinide)
table(dataset2$chlorpropamide)
table(dataset2$glimepiride)
table(dataset2$acetohexamide)
table(dataset2$glipizide)
table(dataset2$glyburide)
table(dataset2$tolbutamide)
table(dataset2$pioglitazone)
table(dataset2$rosiglitazone)
table(dataset2$acarbose)
table(dataset2$miglitol)
table(dataset2$troglitazone)
table(dataset2$tolazamide)
table(dataset2$examide)
table(dataset2$citoglipton)
table(dataset2$insulin)

table(dataset2$glyburide.metformin)
table(dataset2$glipizide.metformin)
table(dataset2$glimepiride.pioglitazone)
table(dataset2$metformin.rosiglitazone)
table(dataset2$metformin.pioglitazone)
```

As the following variables present as near-zero variance variables, they are thereby removed from the dataset.
```{r Filter out prescriptions}
dataset2 <- select(dataset2, -c("metformin", "repaglinide", "nateglinide", "chlorpropamide", "glimepiride", "acetohexamide", "glipizide", "glyburide", "tolbutamide", "pioglitazone", "rosiglitazone", "acarbose", "miglitol", "troglitazone", "tolazamide", "examide", "citoglipton", "insulin", "glyburide.metformin", "glipizide.metformin", "glimepiride.pioglitazone", "metformin.rosiglitazone", "metformin.pioglitazone", "change"))

head(dataset2)
```

### Patient Personal Information
```{r race & gender}
dataset2$race <- as.factor(dataset2$race)
dataset2$gender <- as.factor(dataset2$gender)

class(dataset2$race)
class(dataset2$gender)

table(dataset2$race)
table(dataset2$gender)
```

The age levels listed are in groups of 10 years. To keep the data balanced, these levels can be consolidated into 2 levels: ages 0-60 as YoungerThan60 and 60-100 as OlderThan60.
```{r Age}
table(dataset2$age)

#YoungerThan60 Level
dataset2$age[dataset2$age == "[10-20)"] = "YoungerThan60"
dataset2$age[dataset2$age == "[20-30)"] = "YoungerThan60"
dataset2$age[dataset2$age == "[30-40)"] = "YoungerThan60"
dataset2$age[dataset2$age == "[40-50)"] = "YoungerThan60"
dataset2$age[dataset2$age == "[50-60)"] = "YoungerThan60"

#OlderThan60Level
dataset2$age[dataset2$age == "[60-70)"] = "OlderThan60"
dataset2$age[dataset2$age == "[70-80)"] = "OlderThan60"
dataset2$age[dataset2$age == "[80-90)"] = "OlderThan60"

table(dataset2$age)

dataset2$age <- as.factor(dataset2$age)
```

### Discharge Disposition
To reduce the number of factors, we can change the "discharge_disposition_id" variable to a categorical variable with 2 factors - Discharged to Home & Other. The discharge disposition IDs that correspond to a home discharge are 1, 6, and 8, while the others correspond to a patient being discharged elsewhere.
```{r discharge_disposition_id factors}
discharge.fact <- unique(dataset2$discharge_disposition_id)

discharge.lab <- ifelse(discharge.fact %in% c(1, 6, 8),
                        "Discharged to Home", "Other")

dataset2$discharge_disposition_id <- factor(dataset2$discharge_disposition_id,
                                            levels = discharge.fact,
                                            labels = discharge.lab)

str(dataset2$discharge_disposition_id)
```

***

# Exploratory Data Analysis

## Descriptive Statistics

```{r}
dataset3 <- select(dataset2, -c("diag_1", "diag_2", "diag_3"))
```

```{r Descriptive Statistics}
stat.desc(dataset3)
summary(dataset3)
```

```{r}
str(dataset3)
```

## Correlations
Numeric variable correlations
```{r Correlations}
# diab_num <- diab1[1:8]
# 
# M <- cor(diab_num,
#          method = "pearson")
# M
# corrplot(M,
#          method = "square")
# cor.plot(diab_num)

d_num <- dataset3[, c(7:14, 19:27)]

M <- cor(d_num,
         method = "pearson")
round(M, 2)

corrplot(M,
         method = "square")
cor.plot(d_num)
```

## Plots
```{r ggPairs}
ggpairs(dataset3)
```

### Barplot

#### Outcome Barplots
```{r Readmitted Bar}
#Base comparison
ggplot(dataset3,
       aes(readmitted)) +
  geom_bar()

#Readmission & Discharge disposition
ggplot(dataset3,
       aes(readmitted)) +
  geom_bar(aes(fill = factor(discharge_disposition_id)))
```
* The readmitted barplot shows that a larger percentage of patients that were not readmitted were discharged to home, while a larger percentage of patients that were readmitted were discharged elsewhere. It is important to note that there are a greater number of patients that were readmitted in this sample.

#### Categorical Barplots
```{r Race Bar}
#Base comparison
ggplot(dataset3,
       aes(race)) +
  geom_bar()

#Race & Readmission
ggplot(dataset3,
       aes(race)) +
  geom_bar(aes(fill = factor(readmitted)))
```
* The race bar graph shows that a greater number of Caucasians, Asians, Hispanics, and Other were readmitted. Upon looking at the graph, it appears that more African Americans were not readmitted. For the responses where racial information was not available, the graph shows that more patients were not readmitted.

```{r Gender Bar}
#Base comparison
ggplot(dataset3,
       aes(gender)) +
  geom_bar()

#Gender & Readmission
ggplot(dataset3,
       aes(gender)) +
  geom_bar(aes(fill = factor(readmitted)))
```
* The gender bar graph shows that a greater number of female patients were readmitted than male, though it is important to note that there are more female patients in this sample.

```{r Age Bar}
#Base comparison
ggplot(dataset3,
       aes(age)) +
  geom_bar()

#Race & Readmission
ggplot(dataset3,
       aes(age)) +
  geom_bar(aes(fill = factor(readmitted)))
```
* The age bar graph show that more patients older than 60 were readmitted, though it is important to note that there are a greater number of patients older than 60 in the sample.

### Histograms

```{r}
str(dataset3)
summary(dataset3)
```

#### Histograms grouped by readmission status
```{r Histogram 1}
# Grouped
# p <- data %>%
#   ggplot( aes(x=value, fill=type)) +
#     geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
#     scale_fill_manual(values=c("#69b3a2", "#404080")) +
#     theme_ipsum() +
#     labs(fill="")

#time_in_hospital
hosp_hist <- dataset3 %>%
  ggplot(aes(x = time_in_hospital,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
hosp_hist

#num_lab_procedures
lab_p_hist <- dataset3 %>%
  ggplot(aes(x = num_lab_procedures,
             fill = readmitted)) + 
  geom_histogram(binwidth = 5)
lab_p_hist

#num_procedures
procedures_hist <- dataset3 %>%
  ggplot(aes(x = num_procedures,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
procedures_hist

#num_medications
medications_hist <- dataset3 %>%
  ggplot(aes(x = num_medications,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
medications_hist

#number_outpatient
outpatient_hist <- dataset3 %>%
  ggplot(aes(x = number_outpatient,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
outpatient_hist

#number_emergency
emergency_hist <- dataset3 %>%
  ggplot(aes(x = number_emergency,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
emergency_hist

#number_inpatient
inpatient_hist <- dataset3 %>%
  ggplot(aes(x = number_inpatient,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
inpatient_hist

#number_diagnoses
diagnoses_hist <- dataset3 %>%
  ggplot(aes(x = number_diagnoses,
             fill = readmitted)) + 
  geom_histogram(binwidth = 1)
diagnoses_hist
```
* time_in_hospital histogram is positively skewed and shows that more patients that spent 6 or more days in the hospital were readmitted than not.
* num_lab_procedures histogram appears approximately normal.
* num_procedures, number_outpatient, number_emergency, and number_inpatient histograms are positively skewed, with greater number of readmitted patients. 
* num_medications histogram displays slight positive skewness, though the "YES" readmission histogram seems more normal than the overall graph. A greater number of patients with fewer than 20 medications were not readmitted. 
* number_diagnoses histogram is negatively skewed, showing more patients with a greater number of diagnoses were readmitted.

#### Histograms grouped by Discharge Disposition
```{r Histogram 2}
# Grouped
# p <- data %>%
#   ggplot( aes(x=value, fill=type)) +
#     geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
#     scale_fill_manual(values=c("#69b3a2", "#404080")) +
#     theme_ipsum() +
#     labs(fill="")

#time_in_hospital
hosp_hist <- dataset3 %>%
  ggplot(aes(x = time_in_hospital,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
hosp_hist

#num_lab_procedures
lab_p_hist <- dataset3 %>%
  ggplot(aes(x = num_lab_procedures,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 5)
lab_p_hist

#num_procedures
procedures_hist <- dataset3 %>%
  ggplot(aes(x = num_procedures,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
procedures_hist

#num_medications
medications_hist <- dataset3 %>%
  ggplot(aes(x = num_medications,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
medications_hist

#number_outpatient
outpatient_hist <- dataset3 %>%
  ggplot(aes(x = number_outpatient,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
outpatient_hist

#number_emergency
emergency_hist <- dataset3 %>%
  ggplot(aes(x = number_emergency,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
emergency_hist

#number_inpatient
inpatient_hist <- dataset3 %>%
  ggplot(aes(x = number_inpatient,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
inpatient_hist

#number_diagnoses
diagnoses_hist <- dataset3 %>%
  ggplot(aes(x = number_diagnoses,
             fill = discharge_disposition_id)) + 
  geom_histogram(binwidth = 1)
diagnoses_hist
```
* The histograms grouped by discharge disposition show that a large majority of patients were discharged to their homes.

### Scatter Plots, grouped by Readmission status
```{r Scatter Plots}
#Highest Correlating Variables:
# number_emergency & number_inpatient = 0.5

# BMI_Skin <- ggplot(data = diab1,
#                    aes(x = BMI,
#                        y = SkinThickness,
#                        color = Outcome),
#                    na.rm = TRUE) +
#   geom_point(size = 0.5) +
#   geom_smooth(method = lm) +
#   labs(title = "BMI vs. Skin Thickness")
# BMI_Skin

#number_emergency & number_inpatient = 0.5
em_in <- ggplot(data = dataset3,
                   aes(x = number_inpatient,
                       y = number_emergency,
                       color = readmitted),
                   na.rm = TRUE) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm) +
  labs(title = "Number of Emergency vs. Inpatient visitation")
em_in

#number_emergency & number_outpatient = 0.49
em_out <- ggplot(data = dataset3,
                   aes(x = number_outpatient,
                       y = number_emergency,
                       color = readmitted),
                   na.rm = TRUE) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm) +
  labs(title = "Number of Emergency vs. Outpatient visitation")
em_out

#num_medications & number_diagnoses = 0.49
med_diag <- ggplot(data = dataset3,
                   aes(x = number_diagnoses,
                       y = num_medications,
                       color = readmitted),
                   na.rm = TRUE) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm) +
  labs(title = "Number of Medications vs. Number of Diagnoses")
med_diag

#num_medications & time_in_hospital = 0.44
med_time <- ggplot(data = dataset3,
                   aes(x = time_in_hospital,
                       y = num_medications,
                       color = readmitted),
                   na.rm = TRUE) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm) +
  labs(title = "Number of Medications vs. Time in Hospital")
med_time
```

***

# Predictive Models

## Dummy Variables
```{r dummy}
d <- predict(dummyVars(~discharge_disposition_id + admission_type_id + max_glu_serum + A1Cresult + admission_source_id,
                       data = dataset3),
             newdata = dataset3)

head(d)
```

```{r Adjust dummy column names}
colnames(d)

colnames(d)[colnames(d) == "A1Cresult>7"] <- "A1Cresult7"
colnames(d)[colnames(d) == "A1Cresult>8"] <- "A1Cresult8" 
colnames(d)[colnames(d) == "max_glu_serum>300"] <- "max_glu_serum.300" 
colnames(d)[colnames(d) == "max_glu_serum>200"] <- "max_glu_serum.200"

colnames(d)
```

```{r Column select}
dataset4 <- select(dataset3, c("readmitted", "time_in_hospital", "num_lab_procedures", "num_procedures", "num_medications", "number_outpatient", "number_emergency", "number_inpatient", "number_diagnoses", "diag_circ", "diag_resp", "diag_dig", "diag_diab", "diag_inj", "diag_musc", "diag_geni", "diag_neop", "diag_other"))

head(dataset4)
```

```{r add dummy}
dataset3 <- cbind(dataset4, d)

head(dataset4)
```

```{r d4 rows & columns}
nrow(dataset4)
ncol(dataset4)

dataset4 <- dataset4[ , c("readmitted",
                          names(dataset4)[names(dataset4) != "readmitted"])]

colnames(dataset4)
```

## Train & Test Split
```{r Sample Split}
set.seed(123)
split <- sample.split(dataset4$readmitted,
                      SplitRatio = 0.8)
df.train <- subset(dataset3,
                     split == TRUE)
df.test <- subset(subset(dataset3,
                           split == FALSE))

nrow(df.test)
nrow(df.train)
```

```{r Train Head/Str}
head(df.train)
str(df.train)
```

```{r Rows & Columns}
nrow(df.train)
ncol(df.train)
```

```{r Train/Test NA Check}
sum(is.na(df.train))
sum(is.na(df.test))
```

## Logistic Regression
Coding the readmission status as 0 (No) and 1 (YES).
```{r Binary Readmission 1}
table(dataset4$readmitted)

df.train1 <- df.train
table(df.train1$readmitted)

df.test1 <- df.test
```

```{r Train1 Binary Readmission}
df.train1$readmitted[df.train1$readmitted == "NO"] = 0
df.train1$readmitted[df.train1$readmitted == "YES"] = 1

table(df.train1$readmitted)

df.train1$readmitted <- as.numeric(df.train1$readmitted)
class(df.train1$readmitted)
```

```{r Test1 Binary Readmission}
df.test1$readmitted[df.test1$readmitted == "NO"] = 0
df.test1$readmitted[df.test1$readmitted == "YES"] = 1

df.test1$readmitted <- as.numeric(df.test1$readmitted)
class(df.test1$readmitted)

table(df.test1$readmitted)
```

### Logistic Regression Models
Akaike Information Criterion (AIC) refers to a mathematical method for evaluating how well a model fits the data it was *generated* from. It is used to compare different possible models and determine which is the best fit for the data. A lower AIC score is better.

I will use the AIC scores of each of the following models to determine which features are most significant in determining a patient's readmission status. The model with the lowest AIC score will be used for model prediction against df.test.

#### Log Model 1
```{r Log Model 1}
logModel1 <- glm(formula = readmitted ~ . , 
                 family = binomial,
                 data = df.train1)
summary(logModel1)

#Based on logModel1, the significant values are as follows:
# ** number_inpatient
# * num_procedures
# * diag_diab
# . num_medications
# . diag_other
# . discharge_disposition_id.Other
# . A1Cresult8 

#AIC: 306.11
```

#### Log Model 2
With an AIC result of 289.43, we can assume that logModel2 is better than logModel1 (AIC = 306.11).
```{r Log Model 2}
logModel2 <- glm(formula = readmitted ~ number_inpatient +
                   num_procedures + 
                   diag_diab +
                   num_medications +
                   diag_other +
                   discharge_disposition_id.Other +
                   A1Cresult8, 
                 family = binomial,
                 data = df.train1)
summary(logModel2)

#Based on logModel2, the significant values are as follows:
# *** number_inpatient
# * num_procedures
# * diag_diab
# * num_medications
# * diag_other
# . discharge_disposition_id.Other

#AIC: 289.43
# With an AIC result of 289.43, we can assume that logModel2 is better than logModel1 (AIC = 306.11).
```

#### Log Model 3
With an AIC result of 288.72, we can assume that logModel3 is better than logModel1 (AIC = 306.11) and logModel2 (AIC = 289.43).
```{r Log Model 3}
logModel3 <- glm(formula = readmitted ~ number_inpatient +
                   num_procedures + 
                   diag_diab +
                   num_medications +
                   diag_other +
                   discharge_disposition_id.Other, 
                 family = binomial,
                 data = df.train1)
summary(logModel3)

#Based on logModel3, the significant values are as follows:
# *** number_inpatient
# * num_procedures
# * diag_diab
# * num_medications
# * diag_other
# . discharge_disposition_id.Other

#AIC: 288.72
# With an AIC result of 288.72, we can assume that logModel3 is better than logModel1 (AIC = 306.11) and logModel2 (AIC = 289.43).
```

#### Log Model 4
With an AIC result of 290.23, we can assume that logModel4 is better than logModel1 (AIC = 306.11) but not as good as logModel2 (AIC = 289.43) and logModel3 (AIC = 288.72).
```{r Log Model 4}
logModel4 <- glm(formula = readmitted ~ number_inpatient +
                   num_procedures + 
                   diag_diab +
                   num_medications +
                   diag_other, 
                 family = binomial,
                 data = df.train1)
summary(logModel4)

#Based on logModel4, the significant values are as follows:
# *** number_inpatient
# * num_procedures
# * diag_diab
# * num_medications
# * diag_other

#AIC: 290.23
# With an AIC result of 290.23, we can assume that logModel4 is better than logModel1 (AIC = 306.11) but not as good as logModel2 (AIC = 289.43) and logModel3 (AIC = 288.72).
```

### Logistic Regression Prediction
As logModel3 returned the lowest AIC result (AIC = 288.72) of the 4 logistic regression models, I will continue logistic regression prediction with this model.
```{r Log Predict}
# Outcome.predictions <- predict(logModel1,
#                                df.test,
#                                type = "response")
# 
# log.results <- cbind(Outcome.predictions,
#                      df.test$Outcome)
# 
# results.class <- ifelse(log.results > 0.5, 1,0) 
# colnames(results.class) <- c("pred", "real")
# results.class <- as.data.frame(results.class)
# 
# head(results.class)

readmitted.predictions <- predict(logModel3,
                                  df.test1,
                                  type = "response")

log.results <- cbind(readmitted.predictions,
                     df.test1$readmitted)

results.class <- ifelse(log.results > 0.5, 1, 0)
colnames(results.class) <- c("pred", "real")
results.class <- as.data.frame(results.class)

head(results.class)
```

### Logistic Regression Confusion Matrix
```{r Log Confusion Matrix}
# table(df.test$Outcome,
#       results.class$pred)

table(df.test1$readmitted,
      results.class$pred)
```

```{r Log Confusion Matrix 2}
df.test1$readmitted <- as.factor(df.test1$readmitted)
results.class$pred <- as.factor(results.class$pred)

confusionMatrix(df.test1$readmitted,
                results.class$pred)
```

Logistic regression confusion matrix results:
* Accuracy: 0.6
* Kappa: 0.1955

## K-Nearest Neighbors
K-Nearest Neighbors (KNN) is a simple, supervised machine learning algorithm that can use used to solve both classification and regression problems. 

As the output for the models is a binary factor variable, and KNN can be implemented for classification, I believe that KNN should work well with the data provided.

```{r}
table(df.test1$readmitted)
```

```{r}
# df.test1$readmitted[df.test1$readmitted == 1] = "NO"
# df.test1$readmitted[df.test1$readmitted == 2] = "YES"
# 
# df.test1$readmitted[df.test1$readmitted == "NO"] = 0
# df.test1$readmitted[df.test1$readmitted == "YES"] = 1

df.test1$readmitted <- as.numeric(df.test1$readmitted)
results.class$pred <- as.numeric(results.class$pred)

# table(df.test1$readmitted)
```

```{r}
df.train2 <- df.train1
df.test2 <- df.test1
```

### K-NN
```{r KNN pred}
# Fitting K-NN to the Training set and Predicting the Test set results
y_pred = knn(train = df.train2,
             test = df.test2,
             df.train2$readmitted,
             k = 9)

head(y_pred)

misclass.error = mean(df.test2$readmitted != y_pred)
misclass.error

#Misclass error with K value of 9 = 0.75
```

#### Choosing a K
```{r Choosing a K}
#Choosing a K-value
y_pred <- NULL
error.rate <- NULL

for (i in 1:20){
  set.seed(123)
  y_pred <- knn(train = df.train2,
                test = df.test2,
                df.train2$readmitted,
                k = i)
  error.rate[i] <- mean(df.test2$readmitted != y_pred)
}

error.rate

#Visualize K - Elbow Method

k.values <- 1:20
error.df <- data.frame(error.rate,
                       k.values)

ggplot(error.df,
       aes(k.values,
           error.rate)) +
  geom_point() +
  geom_line(lty = "dotted",
            color = "red")

#Optimal K value: 6
```

#### K-NN with Optimal K value
```{r KNN 2}
y_pred = knn(train = df.train2,
             test = df.test2,
             df.train2$readmitted,
             k = 6)

head(y_pred)

misclass.error = mean(df.test2$readmitted != y_pred)
misclass.error

#Misclass error with K value of 6 = 0.733
```

